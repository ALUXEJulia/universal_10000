<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>普發一萬折扣計算機</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
      color-scheme: light;
    }
    body {
      margin: 0;
      padding: 24px;
      background: #f5f5f7;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 24px 24px 32px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
    }
    h1 {
      font-size: 22px;
      margin: 0 0 4px;
      text-align: center;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      text-align: center;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin: 16px 0 8px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }
    label {
      font-size: 13px;
      color: #333;
    }
    select,
    input[type="number"],
    input[type="text"] {
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 120px;
      box-sizing: border-box;
    }
    select:focus,
    input:focus {
      outline: none;
      border-color: #0070f3;
      box-shadow: 0 0 0 1px rgba(0, 112, 243, 0.2);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 13px;
    }
    th,
    td {
      border-bottom: 1px solid #eee;
      padding: 6px 4px;
      text-align: left;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }
    tbody tr:hover {
      background: #fafbff;
    }
    .align-right {
      text-align: right;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: #0070f3;
      color: #fff;
      margin-top: 8px;
    }
    .btn.secondary {
      background: #e5e7eb;
      color: #111827;
      margin-left: 8px;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .summary {
      margin-top: 16px;
      padding: 12px 14px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
    }
    .summary-label {
      color: #4b5563;
    }
    .summary-value {
      font-weight: 600;
    }
    .summary-value.negative {
      color: #b91c1c;
    }
    .summary-value.positive {
      color: #065f46;
    }
    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
    .error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
    }
    .footer {
      text-align: center;
      font-size: 11px;
      color: #9ca3af;
      margin-top: 28px;
    }
    @media (max-width: 640px) {
      .container {
        padding: 16px;
      }
      table {
        font-size: 12px;
      }
      h1 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>普發一萬折扣計算機</h1>
    <div class="subtitle">
      根據定價級距表自動計算刷卡 / 現金折扣，並依商品定價比例分攤折扣金額。
    </div>

    <!-- 付款方式 -->
    <div class="section-title">1. 付款方式（必選）</div>
    <div class="row">
      <label for="paymentMethod">付款方式：</label>
      <select id="paymentMethod">
        <option value="">請選擇</option>
        <option value="card">刷卡</option>
        <option value="cash">現金</option>
      </select>
    </div>
    <div class="hint">
      規則：<br />
      ‧ 折扣依「全部商品吊牌總金額」對照級距表。<br />
      ‧ 現金折扣使用表中「現金總折金額」。<br />
      ‧ 若總定價 ≥ 60,000 且所有商品「材質」皆非 PT / 混合材質，折扣將少 2,000。<br />
      ‧ 若總定價 &lt; 60,000，則一律使用表中折扣，不調整。<br />
      ‧ 未選擇付款方式時，不進行計算。
    </div>

    <!-- 商品明細 -->
    <div class="section-title" style="margin-top:18px;">2. 商品明細</div>
    <table id="itemsTable">
      <thead>
        <tr>
          <th style="width:40px;">#</th>
          <th>商品型號(非必填)</th>
          <th>材質</th>
          <th class="align-right">吊牌原價</th>
          <th class="align-right">分攤折扣</th>
          <th class="align-right">折扣後金額</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <button class="btn secondary" id="addRowBtn">＋ 新增一列</button>
    <button class="btn secondary" id="clearBtn">清除所有資料</button>

    <!-- （已拿掉「計算折扣」按鈕，改成自動試算） -->
    <div class="error" id="errorBox"></div>

    <!-- 結果 -->
    <div class="section-title" style="margin-top:18px;">3. 計算結果</div>
    <div class="summary">
      <div class="summary-row">
        <span class="summary-label">商品吊牌總金額：</span>
        <span class="summary-value" id="sumPrice">-</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">級距表基礎折扣：</span>
        <span class="summary-value negative" id="baseDiscount">-</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">PT / 混合材質調整：</span>
        <span class="summary-value negative" id="ptAdjust">-</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">實際折扣總額：</span>
        <span class="summary-value negative" id="finalDiscount">-</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">應付總金額：</span>
        <span class="summary-value positive" id="totalPayable">-</span>
      </div>
    </div>

    <div class="hint">
      備註：分攤折扣時會先以四捨五入計算各商品折扣，最後一筆會自動調整，確保分攤折扣加總等於實際折扣總額。
    </div>

    <div class="footer">
      Discount Calculator · v2.0 · 建議依實際 Excel 級距更新程式中的 discountTable
    </div>
  </div>

  <script>
    // ===== 1. 折扣級距表 =====
    // 結構：[定價門檻, 刷卡折扣(金額), 現金總折扣(金額)]
    const discountTable = [
      [10000, 1500, 1500],
      [20000, 2000, 2000],
      [30000, 3000, 3500],
      [40000, 5000, 6000],
      [50000, 5000, 7000],
      [60000, 10000, 12500],
      [70000, 10000, 13500],
      [80000, 10000, 14000],
      [90000, 10000, 14000],
      [100000, 10000, 14000],
      [110000, 10000, 15000],
      [120000, 15000, 20000],
      [130000, 15000, 20000],
      [140000, 15000, 21000],
      [150000, 15000, 21000],
      [160000, 15000, 21000],
      [170000, 20000, 26000],
      [180000, 20000, 26000],
      [190000, 20000, 27000],
      [200000, 20000, 27000],
      [210000, 25000, 32000],
      [220000, 25000, 32000],
      [230000, 25000, 32000],
      [240000, 30000, 37000],
      [250000, 30000, 38000],
      [260000, 30000, 38000],
      [270000, 30000, 38000],
      [280000, 30000, 38000],
      [290000, 30000, 38000],
      [300000, 30000, 39000],
      [310000, 30000, 39000],
      [320000, 30000, 39000],
      [330000, 30000, 39000],
      [340000, 30000, 39000],
      [350000, 30000, 40000],
      [360000, 30000, 40000],
      [370000, 30000, 40000],
      [380000, 30000, 40000],
      [390000, 30000, 40000],
      [400000, 30000, 41000],
      [410000, 30000, 41000],
      [420000, 30000, 41000],
      [430000, 30000, 41000],
      [440000, 30000, 41000],
      [450000, 30000, 42000],
      [460000, 30000, 42000],
      [470000, 30000, 42000],
      [480000, 30000, 42000],
      [490000, 30000, 42000],
      [500000, 30000, 42000]
    ];

    // ===== 2. DOM =====
    const itemsTableBody = document.querySelector("#itemsTable tbody");
    const addRowBtn = document.getElementById("addRowBtn");
    const clearBtn = document.getElementById("clearBtn");
    const paymentMethodSelect = document.getElementById("paymentMethod");
    const errorBox = document.getElementById("errorBox");

    const sumPriceEl = document.getElementById("sumPrice");
    const baseDiscountEl = document.getElementById("baseDiscount");
    const ptAdjustEl = document.getElementById("ptAdjust");
    const finalDiscountEl = document.getElementById("finalDiscount");
    const totalPayableEl = document.getElementById("totalPayable");

    // ===== 3. 工具函式 =====
    function formatCurrency(num) {
      if (isNaN(num)) return "-";
      return num.toLocaleString("zh-TW", { maximumFractionDigits: 0 });
    }

    function createMaterialSelect() {
      const select = document.createElement("select");
      select.className = "material-select";
      const opts = [
        { value: "", label: "請選擇材質" },
        { value: "K金", label: "K金" },
        { value: "PT", label: "PT" },
        { value: "K+PT混合材質", label: "K+PT混合材質" },
        { value: "IGI 培育鑽", label: "IGI 培育鑽" }
      ];
      opts.forEach((o) => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        select.appendChild(opt);
      });
      return select;
    }

    function createItemRow(index) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="align-right">${index}</td>
        <td><input type="text" class="model-input" placeholder="型號(非必填)" /></td>
        <td class="material-cell"></td>
        <td class="align-right">
          <input type="number" class="price-input" min="0" step="1" placeholder="0" style="width:100px;" />
        </td>
        <td class="align-right discount-cell">-</td>
        <td class="align-right net-cell">-</td>
      `;
      const materialCell = tr.querySelector(".material-cell");
      const materialSelect = createMaterialSelect();
      materialCell.appendChild(materialSelect);

      // 自動計算事件（材質變更、價格輸入變更）
      const priceInput = tr.querySelector(".price-input");
      priceInput.addEventListener("input", handleAutoCalc);
      materialSelect.addEventListener("change", handleAutoCalc);

      return tr;
    }

    function refreshRowNumbers() {
      const rows = itemsTableBody.querySelectorAll("tr");
      rows.forEach((tr, idx) => {
        const numCell = tr.querySelector("td:first-child");
        if (numCell) numCell.textContent = idx + 1;
      });
    }

    function addRow() {
      const index = itemsTableBody.querySelectorAll("tr").length + 1;
      const tr = createItemRow(index);
      itemsTableBody.appendChild(tr);
    }

    function resetSummaryAndRows() {
      sumPriceEl.textContent = "-";
      baseDiscountEl.textContent = "-";
      ptAdjustEl.textContent = "-";
      finalDiscountEl.textContent = "-";
      totalPayableEl.textContent = "-";

      const rows = itemsTableBody.querySelectorAll("tr");
      rows.forEach((tr) => {
        const discountCell = tr.querySelector(".discount-cell");
        const netCell = tr.querySelector(".net-cell");
        if (discountCell) discountCell.textContent = "-";
        if (netCell) netCell.textContent = "-";
      });
    }

    function clearAll() {
      itemsTableBody.innerHTML = "";
      for (let i = 0; i < 5; i++) addRow(); // 預設 5 列
      refreshRowNumbers();
      errorBox.textContent = "";
      resetSummaryAndRows();
      paymentMethodSelect.value = "";
    }

    function getDiscountFromTable(totalPrice, method) {
      if (!totalPrice || totalPrice <= 0) return 0;
      let result = 0;
      for (const [threshold, cardDisc, cashDisc] of discountTable) {
        if (totalPrice >= threshold) {
          result = method === "card" ? (cardDisc || 0) : (cashDisc || 0);
        } else {
          break;
        }
      }
      return result;
    }

    function hasPTOrMixed(materials) {
      return materials.some((m) => {
        const s = (m || "").toString();
        const upper = s.toUpperCase();
        return upper.includes("PT") || s.includes("混合");
      });
    }

    // ===== 4. 核心計算 =====
    function calculate() {
      const paymentMethod = paymentMethodSelect.value;

      const rows = Array.from(itemsTableBody.querySelectorAll("tr"));
      const items = [];

      for (const tr of rows) {
        const model = tr.querySelector(".model-input").value.trim();
        const materialSelect = tr.querySelector(".material-select");
        const material = materialSelect ? materialSelect.value : "";
        const priceStr = tr.querySelector(".price-input").value;
        const price = Number(priceStr);

        if (!priceStr || isNaN(price) || price <= 0) {
          continue; // 視為空行
        }
        items.push({ model, material, price, tr });
      }

      if (items.length === 0) {
        // 沒有有效商品 → 不顯示錯誤，只清空結果
        errorBox.textContent = "";
        resetSummaryAndRows();
        return;
      }

      if (!paymentMethod) {
        // 有商品但未選付款方式 → 不計算，只提示
        errorBox.textContent = "請先選擇付款方式（刷卡 / 現金），才會進行折扣計算。";
        resetSummaryAndRows();
        return;
      }

      errorBox.textContent = "";

      // 1. 總定價
      const totalPrice = items.reduce((sum, item) => sum + item.price, 0);

      // 2. 級距表折扣
      const baseDiscount = getDiscountFromTable(totalPrice, paymentMethod);

      // 3. 判斷 PT / 混合材質
      const materials = items.map((item) => item.material);
      const hasPT = hasPTOrMixed(materials);

      // 4. PT 調整
      let ptAdjust = 0;
      if (totalPrice >= 60000 && !hasPT) {
        ptAdjust = -2000;
      }

      // 5. 實際折扣與應付總金額
      let finalDiscount = baseDiscount + ptAdjust;
      if (finalDiscount < 0) finalDiscount = 0;
      if (finalDiscount > totalPrice) finalDiscount = totalPrice;

      const totalPayable = totalPrice - finalDiscount;

      // 6. 分攤折扣
      const finalDiscountRounded = Math.round(finalDiscount);
      let allocated = 0;

      items.forEach((item, idx) => {
        let disc;
        if (idx === items.length - 1) {
          disc = finalDiscountRounded - allocated; // 最後一筆修正
        } else {
          const raw = (item.price / totalPrice) * finalDiscountRounded;
          disc = Math.round(raw);
          allocated += disc;
        }
        if (disc < 0) disc = 0;
        if (disc > item.price) disc = item.price;

        const net = item.price - disc;
        const discountCell = item.tr.querySelector(".discount-cell");
        const netCell = item.tr.querySelector(".net-cell");
        discountCell.textContent = disc > 0 ? "-" + formatCurrency(disc) : "0";
        netCell.textContent = formatCurrency(net);
      });

      // 清空未使用列顯示
      rows.forEach((tr) => {
        const price = Number(tr.querySelector(".price-input").value || 0);
        if (!(price > 0)) {
          const discountCell = tr.querySelector(".discount-cell");
          const netCell = tr.querySelector(".net-cell");
          if (discountCell) discountCell.textContent = "-";
          if (netCell) netCell.textContent = "-";
        }
      });

      // 7. 更新摘要
      sumPriceEl.textContent = formatCurrency(totalPrice);
      baseDiscountEl.textContent =
        baseDiscount > 0 ? "-" + formatCurrency(baseDiscount) : "0";
      ptAdjustEl.textContent =
        ptAdjust !== 0 ? formatCurrency(ptAdjust) : "0";
      finalDiscountEl.textContent =
        finalDiscountRounded > 0 ? "-" + formatCurrency(finalDiscountRounded) : "0";
      totalPayableEl.textContent = formatCurrency(totalPayable);
    }

    function handleAutoCalc() {
      // 任何輸入變動都觸發重算
      calculate();
    }

    // ===== 5. 初始化 =====
    addRowBtn.addEventListener("click", () => {
      addRow();
      refreshRowNumbers();
      calculate(); // 新增列後也重算一次
    });

    clearBtn.addEventListener("click", () => {
      clearAll();
    });

    paymentMethodSelect.addEventListener("change", handleAutoCalc);

    // 初始建立 5 列
    clearAll();
  </script>
</body>
</html>
